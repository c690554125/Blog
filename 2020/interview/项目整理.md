## UE4 项目问题整理

### 工程方面

1. 编译速度，项目代码量臃肿，本地冷启动和打包编译需要 2 分多钟。

   多进程打包，使用 happypack。

   external 掉常用库 react, dva 等，项目本身属于本地资源加载，通过 script 标签直接引入。

   使用 Dllplugin 对一些变动频率低的，比如自己开发的 form 表单组件库进行提前打包。

   **结果**整体编译速度降至 20 多 s。

2. 文件路径系统访问方式优化，TS 本身对项目有路径提示，但 webpack 并不认识 TS 的路径提示，编译会提示模块查询不到。

   1. 手动需配置 alias 和 ts 路径绑定关系，但手写麻烦，容易出错，目录变化也需要做相应的修改，同时修改 webpack.resolve.alias 和 tsconfiig.paths。

   2. 写了个 node 脚本，读取 tsconfig 中的 paths 配置，如果没有配置，遍历 src/目录下直接的子目录，生成一份路径映射表。该表插入到 tsconfig.json 和 webpack.resolve.alias。

   3. 更为成熟的方案，使用 awesome-ts-loader 替换 ts-loader。 里面包含了 ts-config-paths-plugins，作用也是 copy tsconfig 到 webpack 中。

   **结果** 自动映射 ts 和 webpack 的路径解析

3. 开发配置自动切换，针对运行环境，chrome 开发阶段和 UE 虚幻引擎两个环境中运行时配置不同，浏览器开发时需走全链路的 mock，UE 引擎 中和 UE 走真正的 Bridge 交互+全链路交互日志跟踪；针对生产环境和开发环境，还涉及到调试资源加载控制，开发工具显隐控制。除了和 UE 做 Bridge 交互外，前端还有小部分接口和后端直接交互，接口前缀和账号配置信息需根据 UE 引擎提供的环境参数改变。

   1. 针对运行环境根据不同的 userAgent，用于区分当前运行环境，在与 UE 交互的 Jsbridge 方法内部做流程判断，走 mock 还是真实交互。mock 的话，还会加载写好的配套 mock 文件。
   2. 针对生产和开发环境，scripts 命令中注入不同的环境变量，根据环境变量使用对应接口前缀和账号配置；生产环境打包下丢弃开发辅助资源，如 mock 文件，加载从 webpack 中剔除掉，HTML 模板中也丢弃掉 UE 调试工具库的引用。
   3. 开发环境，允许灵活控制接口及账号切换，生产环境则只接受 UE 传递的参数。

**结果** 无需手动修改环境配置，全部自动处理。

### 开发效率

1. 引入 mockjs，完全脱离和 ue 的联调开发阶段。
2. 优化和 UE 的交互，从原本的全局挂载互相访问。结合发布订阅模式+promise，封装 jsbridge，并在发送接收阶段做日志跟踪，监控全链路交互路径和数据，配合 vconsole，方便在 ue 中查看日志。
3. ts 引入，定义交互数据结构，类型，减少因数据访问不当引起的前端崩溃，降低崩溃率。

### 业务上的问题
