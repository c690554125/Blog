## UE4 项目问题整理

### 工程方面

1. 编译速度，项目代码量臃肿，本地冷启动和打包编译需要 2 分多钟。

   多进程打包，使用 happypack。

   external 掉常用库 react, dva 等，项目本身属于本地资源加载，通过 script 标签直接引入。

   使用 Dllplugin 对一些变动频率低的，比如自己开发的 form 表单组件库进行提前打包。

   **结果**整体编译速度降至 20 多 s。

2. 文件路径系统访问方式优化，TS 本身对项目有路径提示，但 webpack 并不认识 TS 的路径提示，编译会提示模块查询不到。

   1. 手动需配置 alias 和 ts 路径绑定关系，但手写麻烦，容易出错，目录变化也需要做相应的修改，同时修改 webpack.resolve.alias 和 tsconfiig.paths。

   2. 写了个 node 脚本，读取 tsconfig 中的 paths 配置，如果没有配置，遍历 src/目录下直接的子目录，生成一份路径映射表。该表插入到 tsconfig.json 和 webpack.resolve.alias。

   3. 更为成熟的方案，使用 awesome-ts-loader 替换 ts-loader。 里面包含了 ts-config-paths-plugins，作用也是 copy tsconfig 到 webpack 中。

   **结果** 自动映射 ts 和 webpack 的路径解析

3. 开发配置自动切换，针对运行环境，chrome 开发阶段和 UE 虚幻引擎两个环境中运行时配置不同，浏览器开发时需走全链路的 mock，UE 引擎 中和 UE 走真正的 Bridge 交互+全链路交互日志跟踪；针对生产环境和开发环境，还涉及到调试资源加载控制，开发工具显隐控制。除了和 UE 做 Bridge 交互外，前端还有小部分接口和后端直接交互，接口前缀和账号配置信息需根据 UE 引擎提供的环境参数改变。

   1. 针对运行环境根据不同的 userAgent，用于区分当前运行环境，在与 UE 交互的 Jsbridge 方法内部做流程判断，走 mock 还是真实交互。mock 的话，还会加载写好的配套 mock 文件。
   2. 针对生产和开发环境，scripts 命令中注入不同的环境变量，根据环境变量使用对应接口前缀和账号配置；生产环境打包下丢弃开发辅助资源，如 mock 文件，加载从 webpack 中剔除掉，HTML 模板中也丢弃掉 UE 调试工具库的引用。
   3. 开发环境，允许灵活控制接口及账号切换，生产环境则只接受 UE 传递的参数。

**结果** 无需手动修改环境配置，全部自动处理。

### 开发效率

1. **分离开发耦合性：**引入 mockjs，完全脱离和 ue 的联调开发阶段。
2. **promise 化交互方式，监控全链路交互：**优化和 UE 的交互，从原本的全局挂载互相访问。结合发布订阅模式+promise，封装 jsbridge，并在发送接收阶段做日志跟踪，监控全链路交互路径和数据，配合 vconsole，方便在 ue 中查看日志。
3. **规范业务数据，降低崩溃率：**ts 引入，定义交互数据结构，类型，减少因数据访问不当引起的前端崩溃，降低崩溃率。
4. **制定交互细则，减少沟通成本，快速定位问题：**参照 REST API 形式，制定了和 UE4 的接口定义，按页面功能区划分接口，分为 3 级，一级代表区域，比如面板/panel 二级代表具体区域哪块业务，比如灯光亮度面板 /panel/light/ 三级代表具体动作 save/del/edit。 接口就是业务描述，联调速度快，出现 BUG 也能很快定位到问题所在。

### 业务上的问题

1. 场景：一个 UE 模型的列表，每个模型需要经过下载才能使用，下载前后的 UI 状态是不一样的，模型每一个有几十 mb，下载时有进度条，用户如果点击了多个下载，此时切换到其他视图层或其他列表页，返回时，会导致原模型下载状态丢失，UI 显示不对。因为 UE 这边和前端这边都没有做一个整体下载状态管理，导致这个状态复原实现难做。如果需要一端做状态下载管理，会增加维护下载队列的成本。

解决方案：
利用发布订阅模式。
UE 将下载中的模型放入指定文件夹，只要该文件夹有文件，比对每个文件当前下载大小和总资源大小，即向前端发布下载进度。前端这边每个模型组件只需要订阅跟自己 ID 对应的下载地址，就可以实现状态更新。且在 componentDidmount 阶段开始订阅，切换页面或列表，销毁阶段取消订阅。

至于列表模型的下载初始状态，UE 通过检查本地模型资源就可以告知到前端。两边都可以最小化改造，不用维护一个专门的下载管理。
