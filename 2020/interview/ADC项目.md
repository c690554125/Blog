## Electron 项目整理

### 工程方面

1. **环境灵活配置**。electron 打包完的 exe 安装包，其环境是确定的，开发和测试阶段，如果想换其他环境，需要安装对应环境的包，但无法同时安装多个环境包，安装阶段会拦截要求卸载。

通过 对应的 script 命令 打包对应环境，如果非 productiion 环境，可以通过修改 exe 程序的启动参数来修改环境。

2. **包版本管理灵活**。安装包包含三个客户端（BIM,UE），另外两端有修改，也需要发包，三端迭代周期不同，包的版本号基于前端项目的 package.json，版本号和更新简介又依赖于运营人员后台配置的信息。要想更新，需要先按照新的版本号及更新信息，打包出新包资源上传到 OSS 上，这就需要开发频繁配合修改项目的 version。

写了一个 node 脚本，打包前根据运营提交的配置信息，修改本地版本号，更新简介。开发不用再介入，后台配置好即可。

### 开发效率

1. **实现 ts 下 redux 的全提示（所有 action，type，参数）。**全项目本身是 TS，但在使用 redux 的时候，编写`reducer`时，和`dispatch action`时，没有对 action 的类型和参数获取很好的提示，导致我们经常需要在各个文件中互相查阅，影响开发效率。

关键是泛型和函数重载的利用。

封装一个创建`action`对象的函数，该函数的函数签名，使用 TS 函数重载，可以接收单个 type，也可以接收 type+params 的形式。而我们传递的 type 和 parmas，则用泛型代表，入参和反参是一致的，这样改函数的反参类型就会是我们传递的所有类型的 type 和 params 的总和。使用这个函数来创建真正的`action`对象即可。

这样就可以在 reducer 函数的 case 判断中获取所有 action 类型提示，和对应类型的参数

也可以在`dispatch action`时，获得 action 需要参数的提示。

### 业务上的问题

1. 场景，electron 的更新，并不是纯前端更新，还需要兼顾其他 2 个端 bim 和 ue。整体包下载重新安装是最为方便，但更新包较大，更新时间长。所以需要实现增量更新。

如果单独列出一份新版本和上一个版本的文件差异列表，更新量是最小的，但是客户端可能会存在跨版本更新，所以按照现成的文件差异列表来下载对应文件替换不可靠。

最终方案是：每次打包，前端生成一份全文件的 json，一个一维数组，列出每个文件的 md5 以及文件相对安装路径。更新优先判断版本号，有差异才开始走更新流程，本地文件和新的文件 json 做一次遍历比较，筛选出 MD5 不同的文件，按照这份列表去下载文件，并保证下载的文件目录结构和本地一直，这样来实现替换。

中间遇到过 assr 文件无法替换的问题，因为 electron 本身为了安全，对 assr 后缀的无法操作，解决办法就是下载文件时就重命名后缀，替换到对应目录后在修改回来。

**结果**：实现增量更新
